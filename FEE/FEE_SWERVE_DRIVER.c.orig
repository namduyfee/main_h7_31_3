/*******************************    INCLUDES   ********************************/

#include "FEE_SWERVE_DRIVER.h"
#include "dwt_stm32_delay.h"
#include "math.h"
/***************************    GLOBAL VARIABLES   ****************************/

uint8_t connect[]= {0x01,0x06,0x20,0xAF,0x00,0x01,0x73,0xEB};
uint8_t che_do_speed[]= {0x01,0x06,0x20,0x0D,0x00,0x03,0x53,0xC8};
uint8_t enable[]= {0x01,0x06,0x20,0x0E,0x00,0x08,0xE2,0x0F};
uint8_t run[]= {0x01,0x06,0x20,0x0E,0x00,0x10,0xE2,0x05};
uint8_t run_dong_bo[]= {0x01,0x06,0x20,0x0F,0x00,0x00,0xB2,0x09};
uint8_t run_dc_trai[]= {0x01,0x06,0x20,0x88,0x00,0x64,0x43,0xB9};
uint8_t run_dong_bo1[]= {0x01,0x10,0x20,0x88,0x00,0x02,0x04,0x00,0x64,0x00,0x64,0x23,0x9C};


extern FEE_MOTOR DC1, DC2, DC3, DC4;

struct AngleInfo {
    double chieu_xoay;
    double goc_xoay;
    uint8_t chieu_tinh_tien;
} result;

FEE_MOTOR SWR1, SWR2, SWR3, SWR4;
int va,vb,vc,vd;
int chieu_tt1=1,chieu_tt2=1,chieu_tt3=0,chieu_tt4;
int van_toc_thuc=0;
float _R,_A,_B,_C,_D,_max,_E;
float speed[4];
int speed_thuc[4];
int16_t Angle1,Angle2,Angle3,Angle4;
int goc_htaiA,goc_htaiB,goc_htaiC,goc_htaiD;
int mode_dc1,mode_dc2,mode_dc3=0;
float _RB_4OM_V_Quay_thuc=0;
int _RB_4OM_van_toc_thuc=0;

/***************************       FUNCTIONS       ****************************/

int Limit(int VT_RAW, int VTG)
{
    if ( VT_RAW > VTG )   VT_RAW=VTG;
    else if ( VT_RAW < -VTG )  VT_RAW=-VTG;
    return VT_RAW;
}

void _Robot_4_omini (uint16_t Van_toc_Chay, int Goc_Chay, uint8_t Van_toc_Xoay, int Goc_Xoay, float HS_Goc,float HS_tang_goc, uint8_t V_tang, uint8_t V_giam)
{
    // Khai bao bien
    int16_t PWMA,PWMB,PWMC,PWMD;//Xung DC
    int8_t chieu1,chieu2,chieu3,chieu4; // Chieu quay DC
    // set van toc tang, giam tu tu
    if ( Van_toc_Chay != _RB_4OM_van_toc_thuc)
    {
        if (_RB_4OM_van_toc_thuc + V_tang < Van_toc_Chay) {
            _RB_4OM_van_toc_thuc += V_tang;
        }
        else if ( _RB_4OM_van_toc_thuc - V_giam> Van_toc_Chay) {
            _RB_4OM_van_toc_thuc -= V_giam;
        }
        else {
            _RB_4OM_van_toc_thuc = Van_toc_Chay;
        }
    }
    // P goc quay cua Robot
    int V_Xoay_tinh=  (Goc_Xoay-AngleRT)* HS_Goc;

    if(V_Xoay_tinh>Van_toc_Xoay) {
        V_Xoay_tinh=Van_toc_Xoay;
    }
    else if(V_Xoay_tinh<-Van_toc_Xoay) {
        V_Xoay_tinh=-Van_toc_Xoay;
    }

    if(_RB_4OM_V_Quay_thuc<V_Xoay_tinh&&V_Xoay_tinh>0) {
        _RB_4OM_V_Quay_thuc+=HS_tang_goc;
    }
    else if (_RB_4OM_V_Quay_thuc>V_Xoay_tinh&&V_Xoay_tinh<0) {
        _RB_4OM_V_Quay_thuc-=HS_tang_goc;
    }
    else (_RB_4OM_V_Quay_thuc=V_Xoay_tinh);
    // Xong P goc quay
    // tinh toc do chay
    Goc_Chay=Goc_Chay-angle;  // nhân 10 goc de tinh toan
    PWMA = _RB_4OM_V_Quay_thuc + _RB_4OM_van_toc_thuc * cos((Goc_Chay - 2250) * 0.00174533); //v A			-2250  PI/1800=0.00174533
    PWMB = _RB_4OM_V_Quay_thuc + _RB_4OM_van_toc_thuc * cos((Goc_Chay + 450)  * 0.00174533); //v B			+450
    PWMC = _RB_4OM_V_Quay_thuc + _RB_4OM_van_toc_thuc * cos((Goc_Chay - 450)  * 0.00174533); //v C			-450
    PWMD = _RB_4OM_V_Quay_thuc + _RB_4OM_van_toc_thuc * cos((Goc_Chay - 1350) * 0.00174533); //v D			-1350
    // Set Chieu và toc do cac dong co

    if(PWMA>0) {
        chieu1=0;
    }
    else {
        PWMA=-PWMA;
        chieu1=1;
    }
    if(PWMB>0) {
        chieu2=0;
    }
    else {
        PWMB=-PWMB;
        chieu2=1;
    }
    if(PWMC>0) {
        chieu3=0;
    }
    else {
        PWMC=-PWMC;
        chieu3=1;
    }
    if(PWMD>0) {
        chieu4=0;
    }
    else {
        PWMD=-PWMD;
        chieu4=1;
    }

    if(PWMA<4) {
        PWMA=2;
    }
    else if(PWMA>250) {
        PWMA=250;
    }
    if(PWMB<4) {
        PWMB=2;
    }
    else if(PWMB>250) {
        PWMB=250;
    }
    if(PWMC<4) {
        PWMC=2;
    }
    else if(PWMC>250) {
        PWMC=250;
    }
    if(PWMD<4) {
        PWMD=2;
    }
    else if(PWMD>250) {
        PWMD=250;
    }
    //Dung khan
    if(ktra_khoa==1)	 {
        PWMA=PWMB=PWMC=PWMD=2;
    }
    // Gui tin hieu dieu khien
    DC1.Dir = chieu1, DC1.Speed = PWMA;
    DC2.Dir = chieu2, DC2.Speed = PWMB;
    DC3.Dir = chieu3, DC3.Speed = PWMC;
    DC4.Dir = chieu4, DC4.Speed = PWMD;
}


void _Robot_cua(uint16_t V_chay,int Goc_chay,float HS_Goc,float HS_tang_goc, uint8_t V_tang, uint8_t V_giam,uint8_t HS_lech)
{
    int16_t PWMA,PWMB,PWMC,PWMD;//Xung DC
    int8_t chieu1,chieu2,chieu3,chieu4; // Chieu quay DC
    if ( V_chay != _RB_4OM_van_toc_thuc)
    {
        if (_RB_4OM_van_toc_thuc + V_tang < V_chay) {
            _RB_4OM_van_toc_thuc += V_tang;
        }
        else if ( _RB_4OM_van_toc_thuc - V_giam> V_chay) {
            _RB_4OM_van_toc_thuc -= V_giam;
        }
        else {
            _RB_4OM_van_toc_thuc = V_chay;
        }
    }


    PWMA= -	V_chay + (Goc_chay-AngleRT)*HS_Goc;
    PWMB= 	V_chay + (Goc_chay-AngleRT)*HS_Goc;

    if(PWMA>0) {
        chieu1=0;
    }
    else {
        PWMA=-PWMA;
        chieu1=1;
    }
    if(PWMB>0) {
        chieu2=0;
    }
    else {
        PWMB=-PWMB;
        chieu2=1;
    }

    if (PWMA<4) {
        PWMA=2;
    }
    else  if (PWMA>250) {
        PWMA=250;
    }
    if (PWMB<4) {
        PWMB=2;
    }
    else  if (PWMB>250) {
        PWMB=250;
    }
    //Dung khan
    if(ktra_khoa==1) {
        PWMA=PWMB=PWMC=PWMD=2;
    }
    // Gui tin hieu dieu khien
    DC1.Dir = chieu1, DC1.Speed = PWMA;
    DC2.Dir = chieu2, DC2.Speed = PWMB - HS_lech;
    DC3.Dir = chieu3, DC3.Speed = PWMC;
    DC4.Dir = chieu4, DC4.Speed = PWMD;
}

int G_SS_Run(int G_Run, int ADC_RUn, int ADC_Now, float HS_Goc, int Bu_G_Max)
{
    int SS_ADC=(-ADC_Now+ADC_RUn)/100;
    int G_Run_Tinh =  SS_ADC*HS_Goc;
    if(G_Run_Tinh>Bu_G_Max) {
        return G_Run+Bu_G_Max;
    }
    else if (G_Run_Tinh<-Bu_G_Max) {
        return G_Run-Bu_G_Max;
    }
    else return G_Run+G_Run_Tinh;
}

int G_SS_Run_2(int G_Run, int ADC_Run, int ADC_Now, float HS_Goc, int Bu_G_Max)
{
    int SS_ADC=(-ADC_Run+ADC_Now)/100;
    int G_Run_Tinh =  SS_ADC*HS_Goc;
    if(G_Run_Tinh>Bu_G_Max) {
        return G_Run+Bu_G_Max;
    }
    else if (G_Run_Tinh<-Bu_G_Max) {
        return G_Run-Bu_G_Max;
    }
    else return G_Run+G_Run_Tinh;
}


int songSongThanh(int adc_kc_thanh,int adc_ht,int sai_so_adc,int goc_chay,int sai_so,int chieu)
{
    //debug_adc_ht = adc_ht;
    uint16_t k;
    int khoang_cach_adc= adc_ht-adc_kc_thanh;
    if(khoang_cach_adc>=0)          khoang_cach_adc=khoang_cach_adc/sai_so_adc;
    else if( khoang_cach_adc<=0)    khoang_cach_adc=-khoang_cach_adc/sai_so_adc;

    if(chieu==0)
    {
        if(adc_ht>adc_kc_thanh) {
            k=goc_chay+(khoang_cach_adc);
        }
        if(adc_ht<adc_kc_thanh) {
            k=goc_chay-(khoang_cach_adc);
        }
    }
    if(chieu==1)
    {
        if(adc_ht<adc_kc_thanh) {
            k=goc_chay+(khoang_cach_adc);
        }
        if(adc_ht>adc_kc_thanh) {
            k=goc_chay-(khoang_cach_adc);
        }
    }
    if(k>goc_chay+sai_so) {
        return k=goc_chay+sai_so;
    }
    else if (k<goc_chay-sai_so) {
        return k=goc_chay-sai_so;
    }
    else return k;
}

int TocDoen(int v0, int v1, int vmax,int quangduonght, uint16_t quangDuongCanDen, int phanTramTangToc, int phanTramGiamToc)
{
    uint16_t vt1;
    uint16_t quangDuongTangToc = (quangDuongCanDen * phanTramTangToc) / 100;
    uint16_t quangDuongGiamToc = (quangDuongCanDen * phanTramGiamToc) / 100;

    if (quangduonght < quangDuongTangToc) {
        vt1 = v0 + (vmax - v0) * quangduonght/ quangDuongTangToc;
    }
    if (quangduonght >= (quangDuongCanDen-quangDuongGiamToc) && quangduonght < quangDuongCanDen) {
        //     vt1 = vmax - (vmax - v1) * (quangduonght-(quangDuongCanDen-quangDuongGiamToc))/(quangDuongCanDen-(quangDuongCanDen-quangDuongGiamToc));
        vt1=v1+(vmax-v1)*(quangDuongCanDen-quangduonght)/quangDuongGiamToc;
    }
    return vt1;
}

uint16_t tocdo_1(uint16_t en, uint16_t toc_do_thap,uint16_t toc_do_cao,uint16_t quang_duong,uint16_t quang_duong_tang,uint16_t quang_duong_giam)
{
    int16_t l1,l2;
    uint16_t vt1;
    l1=(quang_duong_tang*quang_duong)/100;
    l2=((100-quang_duong_giam)*quang_duong)/100;
    if(en<l1) {
        vt1=toc_do_cao;
    }
    if(en>=l2&&en<quang_duong) {
        vt1=toc_do_cao-(toc_do_cao-toc_do_thap)*(en-l2)/(quang_duong-l2);
    }
    return vt1;
}

int tinh_goc_xoay(int goc_can_lay, int van_toc_goc)
{
    int output_c;
    int sai_so_goc_truoc, sai_so_goc;
    sai_so_goc =  goc_can_lay-angle;
    output_c = sai_so_goc*0.2+sai_so_goc*0.0001;
    output_c = Limit(output_c, van_toc_goc);
    return output_c;
}

int TocDo1(int v0, int v1, int vmax,int viTriHtai,int viTriGoc, int quangDuongCanDen, int phanTramTangToc, int phanTramGiamToc) {
    uint16_t vt;
    quangDuongCanDen=quangDuongCanDen-viTriGoc;
    int khoang_cach_ht = viTriHtai-viTriGoc;
    uint16_t quangDuongTangToc = (abs(quangDuongCanDen) * phanTramTangToc) / 100;
    uint16_t quangDuongGiamToc = (abs(quangDuongCanDen) * phanTramGiamToc) / 100;
    if (abs(khoang_cach_ht) < quangDuongTangToc) {
        vt = v0 + (vmax - v0) * abs(khoang_cach_ht) / quangDuongTangToc;
    }
    if (abs(khoang_cach_ht) >= (abs(quangDuongCanDen)-quangDuongGiamToc) && abs(khoang_cach_ht) < abs(quangDuongCanDen)) {
        vt = vmax - (vmax - v1) * (abs(khoang_cach_ht)-(abs(quangDuongCanDen)-quangDuongGiamToc)) / (abs(quangDuongCanDen)-(abs(quangDuongCanDen)-quangDuongGiamToc));
    }
    return vt;
}


void xoay_dc1(int goc_banh,float toc_do) {
    uint64_t en_xoay=(abs(goc_banh)*10020*7)/360;
    HAL_GPIO_WritePin(GPIOC,GPIO_PIN_2,!SWR1.Dir);
    if(SWR1.Dir==0) {
        va=va+en_xoay;
    }
    else {
        va=va-en_xoay;
    };
    while(en_xoay--)
    {
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_0,1);
        DWT_Delay_us(toc_do);
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_0,0);
        DWT_Delay_us(toc_do);
    }
}
void xoay_dc2(int goc_banh,float toc_do) {
    uint64_t en_xoay=(abs(goc_banh)*10020*7)/360;
    HAL_GPIO_WritePin(GPIOC,GPIO_PIN_3,!SWR2.Dir);
    //if(SWR2.Dir==0){vb=vb+en_xoay;}else {vb=vb-en_xoay;};
    while(en_xoay--)
    {
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_1,1);
        DWT_Delay_us(toc_do);
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_1,0);
        DWT_Delay_us(toc_do);
    }
}
void xoay_dc3(int goc_banh,float toc_do) {
    uint64_t en_xoay=(abs(goc_banh)*10020*7)/360;
    HAL_GPIO_WritePin(GPIOC,GPIO_PIN_9,!SWR3.Dir);
    while(en_xoay--)
    {
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_2,1);
        DWT_Delay_us(toc_do);
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_2,0);
        DWT_Delay_us(toc_do);
    }
}
void xoay_dc4(int goc_banh,float toc_do) {
    uint64_t en_xoay=(abs(goc_banh)*10020*7)/360;
    HAL_GPIO_WritePin(GPIOA,GPIO_PIN_4,!SWR4.Dir);
    //if(SWR4.Dir==1){vd=vd+en_xoay;}else {vd=vd-en_xoay;};
    while(en_xoay--)
    {
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_3,1);
        DWT_Delay_us(toc_do);
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_3,0);
        DWT_Delay_us(toc_do);
    }
}
double modulo(double a, double b)
{
    return (double)(a - b * floor(a / b));
}
double closestAngle(double a, double b)
{
    // L?y hu?ng
    double dir;
    dir = modulo(b, 360.0) - modulo(a, 360.0);

    // Chuy?n d?i t? -360 d?n 360 thành -180 d?n 180
    if (fabs(dir) > 180.0)
    {
        dir = -(copysign(1.0,dir)*360)+dir;
        //(dir < 0) ? dir + 360.0 : dir - 360.0;
    }
    return dir;
}

void goc_gan_nhat(struct AngleInfo *result,int16_t goc_htai,int16_t goc_moi,int16_t xd_angle)
{
    int x,y;
    x = closestAngle(goc_htai, goc_moi);
    y = closestAngle(goc_htai, goc_moi + 180.0);
    
    result->goc_xoay = (abs(x) <= abs(y)) ? x : y;
    result->chieu_xoay = (result->goc_xoay > 0) ? 0 : 1;

    if(xd_angle == 1)
        chieu_tt1 = (abs(x) <= abs(y)) ? chieu_tt1 : !chieu_tt1;
    else if(xd_angle == 2)
        chieu_tt2 = (abs(x) <= abs(y)) ? chieu_tt2 : !chieu_tt2;  
    else if(xd_angle == 3)
        chieu_tt3 = (abs(x) <= abs(y)) ? chieu_tt3 : !chieu_tt3;
    else if(xd_angle == 4)
        chieu_tt4 = (abs(x) <= abs(y)) ? chieu_tt4 : !chieu_tt4;
}
void Tim_goc_gan_nhat(struct AngleInfo *result,int16_t goc_htai,int16_t goc_moi,int16_t xd_angle)
{
    int16_t x = goc_htai - goc_moi;
    int16_t y = goc_htai - (goc_moi+180.0);
    
    result->chieu_xoay = (result->goc_xoay > 0) ? 0 : 1;
    if(xd_angle == 1)
        chieu_tt1 = (abs(x) <= abs(y)) ? chieu_tt1 : !chieu_tt1;
    else if(xd_angle == 2)
        chieu_tt2 = (abs(x) <= abs(y)) ? chieu_tt2 : !chieu_tt2;  
    else if(xd_angle == 3)
        chieu_tt3 = (abs(x) <= abs(y)) ? chieu_tt3 : !chieu_tt3;
    else if(xd_angle == 4)
        chieu_tt4 = (abs(x) <= abs(y)) ? chieu_tt4 : !chieu_tt4;
}
void Swerve_4(int huong_chay,int toc_do,int goc_xoay,float _L,float _W,int tang,int giam,int HS)//duyken166
{
    int sai_so_goc=(goc_xoay-AngleRT)*HS;

    if(toc_do<van_toc_thuc) {
        van_toc_thuc-=giam;
        if(van_toc_thuc<toc_do) {
            van_toc_thuc=toc_do;
        }
    }
    if(toc_do>van_toc_thuc) {
        van_toc_thuc+=tang;
        if(van_toc_thuc>toc_do) {
            van_toc_thuc=toc_do;
        }
    }

    _R=sqrt(pow(_L, 2) + pow(_W, 2));

    _A=sin((huong_chay-AngleRT)*(PI/180))-sin(sai_so_goc*(PI/180))*(_L/_R);
    _B=sin((huong_chay-AngleRT)*(PI/180))+sin(sai_so_goc*(PI/180))*(_L/_R);
    _C=cos((huong_chay-AngleRT)*(PI/180))-sin(sai_so_goc*(PI/180))*(_W/_R);
    _D=cos((huong_chay-AngleRT)*(PI/180))+sin(sai_so_goc*(PI/180))*(_W/_R);

    speed[0]=sqrt(pow(_B, 2) + pow(_C, 2));
    speed[1]=sqrt(pow(_B, 2) + pow(_D, 2));
    speed[2]=sqrt(pow(_A, 2) + pow(_D, 2));
    speed[3]=sqrt(pow(_A, 2) + pow(_C, 2));

    _max=speed[0];
    for(int i=1; i<4; i++) {
        if(speed[i]>_max) {
            _max=speed[i];
        }
    }

    if(ktra_khoa==1) {
        toc_do=0;
    }

    speed_thuc[0] = (_max > 1) ? (speed[0]/_max)*van_toc_thuc : speed[0]*van_toc_thuc;
    speed_thuc[1] = (_max > 1) ? (speed[1]/_max)*van_toc_thuc : speed[1]*van_toc_thuc;
    speed_thuc[2] = (_max > 1) ? (speed[2]/_max)*van_toc_thuc : speed[2]*van_toc_thuc;
    speed_thuc[3] = (_max > 1) ? (speed[3]/_max)*van_toc_thuc : speed[3]*van_toc_thuc;

    Angle1=(1.5707-atan2(_C,_B))*(180/PI);
    Angle2=(1.5707-atan2(_D,_B))*(180/PI);   // 15707 = pi/2
    Angle3=(1.5707-atan2(_D,_A))*(180/PI);
    Angle4=(1.5707-atan2(_C,_A))*(180/PI);

    if(Angle1-goc_htaiA!=0) {
        goc_gan_nhat(&result,goc_htaiA,Angle1,1);
        SWR1.Dir=result.chieu_xoay;
        SWR1.Angle=result.goc_xoay;
        xoay_dc1(SWR1.Angle,10);
    }
    if(Angle2-goc_htaiB!=0) {
        goc_gan_nhat(&result,goc_htaiB,Angle2,2);
        SWR2.Dir=result.chieu_xoay;
        SWR2.Angle=result.goc_xoay;
        xoay_dc2(SWR2.Angle,10);
    }
    if(Angle3-goc_htaiC!=0) {
        goc_gan_nhat(&result,goc_htaiC,Angle3,3);
        SWR3.Dir=result.chieu_xoay;
        SWR3.Angle=result.goc_xoay;
        xoay_dc3(SWR3.Angle,10);
    }
    if(Angle4-goc_htaiD!=0) {
        goc_gan_nhat(&result,goc_htaiD,Angle4,4);
        SWR4.Dir=result.chieu_xoay;
        SWR4.Angle=result.goc_xoay;
        xoay_dc4(SWR4.Angle,10);
    }
//pid_dc1(chieu_tt1,speed_thuc[0]);
//pid_dc2(chieu_tt2,speed_thuc[1]);
//pid_dc3(chieu_tt3,speed_thuc[2]);
//pid_dc4(chieu_tt4,speed_thuc[3]);
// code dung
    DC1.Dir = chieu_tt1;
    DC1.Speed = speed_thuc[0];
    DC2.Dir = chieu_tt2;
    DC2.Speed = speed_thuc[1];
    DC3.Dir = chieu_tt3;
    DC3.Speed = speed_thuc[2];
    DC4.Dir = chieu_tt4;
    DC4.Speed = speed_thuc[3];
    goc_htaiA=Angle1;
    goc_htaiB=Angle2;
    goc_htaiC=Angle3;
    goc_htaiD=Angle4;

}


///3 banh swerve
void Swerve_3(int huong_chay,int toc_do,int goc_xoay,int toc_do_xoay,float _L,float _W,int tang,int giam,int HS)
{
    int sai_so_goc=(goc_xoay-AngleRT);
//		int ss= abs(sai_so_goc);
//		int a=	((pow(ss*0.1,2)*254) >254 ) ? (254) : (pow(ss*0.1,2)*254) ;
//		int RCW= ( sai_so_goc ==0 ) ? (0) : ((a*sai_so_goc/ss)*toc_do_xoay/100) ;
    int ss= abs(sai_so_goc*1);
    int a=	(ss >254 ) ? (254) : (ss) ;
    int RCW= ( sai_so_goc ==0 ) ? (0) : ((a*sai_so_goc/abs(sai_so_goc))*toc_do_xoay/100);
    if(toc_do<van_toc_thuc) {
        van_toc_thuc-=giam;
        if(van_toc_thuc<toc_do) {
            van_toc_thuc=toc_do;
        }
    }
    if(toc_do>van_toc_thuc) {
        van_toc_thuc+=tang;
        if(van_toc_thuc>toc_do) {
            van_toc_thuc=toc_do;
        }
    }

    _R=sqrt(pow(_L, 2) + pow(_W, 2));

    _A=sin((huong_chay-AngleRT)*(PI/180))*toc_do-RCW*(_W/_R);
    _B=sin((huong_chay-AngleRT)*(PI/180))*toc_do+RCW*(_W/_R);
    _C=cos((huong_chay-AngleRT)*(PI/180))*toc_do-RCW*(_L/_R);
    _D=cos((huong_chay-AngleRT)*(PI/180))*toc_do+RCW*(_L/_R);


    speed[0]=sqrt(pow(_B, 2) + pow(_C, 2));
    speed[1]=sqrt(pow(_B, 2) + pow(_D, 2));
    speed[2]=sqrt(pow(_A, 2) + pow(cos((huong_chay-AngleRT)*(PI/180))*toc_do, 2));

    _max=speed[0];
    for(int i=1; i<3; i++) {
        if(speed[i]>_max) {
            _max=speed[i];
        }
    }

    if(ktra_khoa==1) {
        toc_do=0;
    }

    speed_thuc[0] = (_max > 254) ? ((speed[0]/_max)*254): (speed[0]);// tocdo banh xe 1
    speed_thuc[1] = (_max > 254) ? ((speed[1]/_max)*254): (speed[1]);// tocdo banh xe 2
    speed_thuc[2] = (_max > 254) ? ((speed[2]/_max)*254): (speed[2]);// tocdo banh xe 3


    Angle1=(1.5707-atan2(_C,_B))*(180/PI);// goc banh xe 1
    Angle2=(1.5707-atan2(_D,_B))*(180/PI);//goc banh xe 2
    Angle3=(1.5707-atan2(cos((huong_chay-AngleRT)*(PI/180))*toc_do,_A))*(180/PI);// goc banh xe 3

// xoay dc xoay1
    if(Angle1-goc_htaiA!=0) {
        goc_gan_nhat(&result,goc_htaiA,Angle1,1);
        SWR1.Dir=result.chieu_xoay;
        SWR1.Angle=result.goc_xoay;// goc_dc1 laf goc thuc cua banh xe 1
        mode_dc1=1;
    }
    if(Angle2-goc_htaiB!=0) {
        goc_gan_nhat(&result,goc_htaiB,Angle2,2);
        SWR2.Dir=result.chieu_xoay;
        SWR2.Angle=result.goc_xoay;// goc_dc2 laf goc thuc cua banh xe 1
        mode_dc2=1;
    }//xoay dc xoay 2
    if(Angle3-goc_htaiC!=0)
    {
        goc_gan_nhat(&result,goc_htaiC,Angle3,3);
        SWR3.Dir=result.chieu_xoay;
        SWR3.Angle=result.goc_xoay;// goc_dc3 laf goc thuc cua banh xe 1
        mode_dc3=1;
    }//xoay dc xoay 3

//mode_dc1=mode_dc2=mode_dc3=0;
//pid_dc1(chieu_tt1,speed_thuc[0]);  //chieu_tt1
//pid_dc2(chieu_tt2,speed_thuc[1]);
//pid_dc3(chieu_tt3,speed_thuc[2]);
    //
    DC1.Dir = chieu_tt1;
    DC1.Speed = speed_thuc[0];
    DC2.Dir = chieu_tt2;
    DC2.Speed = speed_thuc[1];
    DC3.Dir = chieu_tt3;
    DC3.Speed = speed_thuc[2];
    goc_htaiA=Angle1;
    goc_htaiB=Angle2;
    goc_htaiC=Angle3;

}

void delay(int d) {
    while(d--) {
        DWT_Delay_us(50000000);
    }
}
void vegoc0(int chieu)
{
//    uint64_t en_xoay=(360*1920*5)/360;
    HAL_GPIO_WritePin(GPIOA,GPIO_PIN_4,chieu);
    HAL_GPIO_WritePin(GPIOC,GPIO_PIN_2,chieu);
    HAL_GPIO_WritePin(GPIOC,GPIO_PIN_3,chieu);
    HAL_GPIO_WritePin(GPIOC,GPIO_PIN_9,chieu);

    while( (FEE_RTOS_struct.H_GPIO.S9==0
            ||FEE_RTOS_struct.H_GPIO.S14==0||FEE_RTOS_struct.H_GPIO.S12==0))
    {
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_0,!FEE_RTOS_struct.H_GPIO.S14);
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_1,!FEE_RTOS_struct.H_GPIO.S9);
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_2,!FEE_RTOS_struct.H_GPIO.S12);
        DWT_Delay_us(50);
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_0,0);
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_1,0);
        HAL_GPIO_WritePin(GPIOA,GPIO_PIN_2,0);
        DWT_Delay_us(50);
    }
}

void vegoc03()
{
    int chieu03=3;
    HAL_Delay(500);
    int dem1=1;
    while(FEE_PES.L1==1)
    {
        while(FEE_PES.Left==1&&FEE_PES.Right==1)
        {
            osDelay(1);
            if(FEE_PES.Select==0)
            {
                while(FEE_PES.Select==0)
                {
                    osDelay(1);
                }
                dem1++;
            }
            if(dem1==4)
            {
                dem1=1;
            }
        };

        if(dem1==1)
        {
            if(FEE_PES.Left==0)
            {
                chieu03=1;
                HAL_GPIO_WritePin(GPIOC,GPIO_PIN_2,chieu03);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_0,1);
                DWT_Delay_us(10);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_0,0);
                DWT_Delay_us(10);
            }

            else if(FEE_PES.Right==0) {
                chieu03=0;
                HAL_GPIO_WritePin(GPIOC,GPIO_PIN_2,chieu03);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_0,1);
                DWT_Delay_us(10);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_0,0);
                DWT_Delay_us(10);
            }
            else if(FEE_PES.Right==1 && FEE_PES.Left==1) {
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_0,0);
            }
        }


        else if(dem1==2)
        {
            if(FEE_PES.Left==0) {
                chieu03=1;
                HAL_GPIO_WritePin(GPIOC,GPIO_PIN_3,chieu03);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_1,1);
                DWT_Delay_us(10);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_1,0);
                DWT_Delay_us(10);
            }
            else if(FEE_PES.Right==0) {
                chieu03=0;
                HAL_GPIO_WritePin(GPIOC,GPIO_PIN_3,chieu03);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_1,1);
                DWT_Delay_us(10);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_1,0);
                DWT_Delay_us(10);
            }
            else if(FEE_PES.Right==1 && FEE_PES.Left==1) {
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_1,0);
            }
        }
        else if(dem1==3)
        {
            if(FEE_PES.Left==0) {
                chieu03=1;
                HAL_GPIO_WritePin(GPIOC,GPIO_PIN_9,chieu03);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_2,1);
                DWT_Delay_us(10);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_2,0);
                DWT_Delay_us(10);
            }

            else if(FEE_PES.Right==0) {
                chieu03=0;
                HAL_GPIO_WritePin(GPIOC,GPIO_PIN_9,chieu03);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_2,1);
                DWT_Delay_us(10);
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_2,0);
                DWT_Delay_us(10);
            }
            else if(FEE_PES.Right==1 && FEE_PES.Left==1) {
                HAL_GPIO_WritePin(GPIOA,GPIO_PIN_2,0);
            }
        }
    }
}

void stop_sw(int banh1,int banh2,int banh3,int toc_do)
{
//	pid_dc1(chieu_tt1,30);  //speed_thuc[0]
//	pid_dc2(chieu_tt2,30);  //speed_thuc[1]
//	pid_dc3(chieu_tt3,30);  //speed_thuc[2]
    DC1.Dir = chieu_tt1;
    DC1.Speed = 30;
    DC2.Dir = chieu_tt2;
    DC2.Speed = 30;
    DC3.Dir = chieu_tt3;
    DC3.Speed = 30;

    if(banh1-goc_htaiA!=0) {
        goc_gan_nhat(&result,goc_htaiA,banh1,1);
        SWR1.Dir=result.chieu_xoay;
        SWR1.Angle=result.goc_xoay;
        mode_dc1=1;
    }
    if(banh2-goc_htaiB!=0) {
        goc_gan_nhat(&result,goc_htaiB,banh2,2);
        SWR2.Dir=result.chieu_xoay;
        SWR2.Angle=result.goc_xoay;
        mode_dc2=1;
    }
    if(banh3-goc_htaiC!=0) {
        goc_gan_nhat(&result,goc_htaiC,banh3,3);
        SWR3.Dir=result.chieu_xoay;
        SWR3.Angle=result.goc_xoay;
        mode_dc3=1;
    }

    goc_htaiA=banh1;
    goc_htaiB=banh2;
    goc_htaiC=banh3;
}

void ve_vt()
{
    int ma=abs(va)/(1920*5);
    int mb=abs(vb)/(1920*5);
    int mc=abs(vc)/(1920*5);

    if(ma>=1) {
        if(va<0) {
            SWR1.Dir=0;
        }
        else {
            SWR1.Dir=1;
        };
        xoay_dc1(ma*360,10);
        va=0;
    }
    if(mb>=1) {
        if(vb<0) {
            SWR2.Dir=0;
        }
        else {
            SWR2.Dir=1;
        };
        xoay_dc2(mb*360,10);
        vb=0;
    }
    if(mc>=1) {
        if(vc<0) {
            SWR3.Dir=0;
        }
        else {
            SWR3.Dir=1;
        };
        xoay_dc3(mc*360,10);
        vc=0;
    }
}


void Stop_PID()
{
    _RB_4OM_van_toc_thuc=0;
    DC1.Dir = 0;
    DC1.Speed = 2;
    DC2.Dir = 1;
    DC2.Speed = 2;
    DC3.Dir = 1;
    DC3.Speed = 2;
    DC4.Dir = 0;
    DC4.Speed = 2;
}