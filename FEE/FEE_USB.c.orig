#include "main.h"
#include "usbd_customhid.h"
#include "FEE_USB.h"

extern struct FEE_def           FEE;
extern USBD_HandleTypeDef 								*pdev1;
extern USBD_CUSTOM_HID_HandleTypeDef     *hhid1;

int pj = 0;
uint8_t data_read[40] = {0,};
void FEE_USB_Innit()
{
    for(pj = 0; pj < 64; pj++)
    {
        FEE.H_USB.USB_Data_IN[pj] = 0;
        FEE.H_USB.USB_Data_OUT[pj] = 0;
    }

    FEE.H_USB.USB_Data_OUT[0] = 'N';
    FEE.H_USB.USB_Data_OUT[1] = 'A';

    FEE.H_USB.Ui							= 0;
    FEE.H_USB.Uj 							= 0;
    FEE.H_USB.USB_Verify			= 0;
    FEE.H_USB.USB_Connect			= 0;
    FEE.H_USB.USB_Send				= 0;



    FEE.H_USB.HID_Counter 		= 0;
    FEE.H_USB.HID_Counter2 		= 0;

    FEE.H_USB.HID_Tick 				= 0;
    FEE.H_USB.HID_Tick2 			= 0;
    FEE.H_USB.HID_Update 			= 0;
}

void HID_Send_Packet(void)
{
    // Get ADC value
    //HAL_ADC_Start(&hadc1);
    //HAL_ADC_PollForConversion(&hadc1, 10);
    //adc_value[0] = HAL_ADC_GetValue(&hadc1);
    FEE.H_USB.USB_Data_OUT[2]  =  FEE.H_GPIO.GPIO_EXTI;
    FEE.H_USB.USB_Data_OUT[3]  =  FEE.H_GPIO.GPIO_S1_S8;
    FEE.H_USB.USB_Data_OUT[4]  =  FEE.H_GPIO.GPIO_S9_S16;
    FEE.H_USB.USB_Data_OUT[5]  =  FEE.H_GPIO.GPIO_S17_S21;
    FEE.H_USB.USB_Data_OUT[6]  =  FEE.H_GPIO.GPIO_S22_S29;
    FEE.H_USB.USB_Data_OUT[7]  =  FEE.H_GPIO.GPIO_S30_S37;// d
    FEE.H_USB.USB_Data_OUT[8]  =  FEE.H_GPIO.GPIO_S38_S45;//
    FEE.H_USB.USB_Data_OUT[9]  =  FEE.H_ADC.adc_value_Raw[0] / 256;//
    FEE.H_USB.USB_Data_OUT[10] =  FEE.H_ADC.adc_value_Raw[0] % 256;//
    FEE.H_USB.USB_Data_OUT[11] =  FEE.H_ADC.adc_value_Raw[1] / 256;//
    FEE.H_USB.USB_Data_OUT[12] =  FEE.H_ADC.adc_value_Raw[1] % 256;//
    FEE.H_USB.USB_Data_OUT[13] =  FEE.H_ADC.adc_value_Raw[2] / 256;
    FEE.H_USB.USB_Data_OUT[14] =  FEE.H_ADC.adc_value_Raw[2] % 256;//
    FEE.H_USB.USB_Data_OUT[15] =  FEE.H_ADC.adc_value_Raw[3] / 256;
    FEE.H_USB.USB_Data_OUT[16] =  FEE.H_ADC.adc_value_Raw[3] % 256;//
    FEE.H_USB.USB_Data_OUT[17] =  FEE.H_ADC.adc_value_Raw[4] / 256;
            FEE.H_USB.USB_Data_OUT[18] =  FEE.H_ADC.adc_value_Raw[4] % 256;//
            FEE.H_USB.USB_Data_OUT[19] =  FEE.H_ADC.adc_value_Raw[5] / 256;
            FEE.H_USB.USB_Data_OUT[20] =  FEE.H_ADC.adc_value_Raw[5] % 256;//
            FEE.H_USB.USB_Data_OUT[21] =  FEE.H_ADC.adc_value_Raw[6] / 256;
            FEE.H_USB.USB_Data_OUT[22] =  FEE.H_ADC.adc_value_Raw[6] % 256;//
            FEE.H_USB.USB_Data_OUT[23] =  FEE.H_ADC.adc_value_Raw[7] / 256;
            FEE.H_USB.USB_Data_OUT[24] =  FEE.H_ADC.adc_value_Raw[7] % 256;//
    if(FEE.H_EEprom.Read_Start == 0)
    {
//    FEE.H_USB.USB_Data_OUT[2]  = 	FEE.H_GPIO.GPIO_EXTI;
//    FEE.H_USB.USB_Data_OUT[3]  = 	FEE.H_GPIO.GPIO_S1_S8;
//    FEE.H_USB.USB_Data_OUT[4]  = 	FEE.H_GPIO.GPIO_S9_S16;
//    FEE.H_USB.USB_Data_OUT[5]  = 	FEE.H_GPIO.GPIO_S17_S21;
//    FEE.H_USB.USB_Data_OUT[6]  = 	FEE.H_GPIO.GPIO_S22_S29;
//    FEE.H_USB.USB_Data_OUT[7]  = 	FEE.H_GPIO.GPIO_S30_S37;// d
//    FEE.H_USB.USB_Data_OUT[8]  = 	FEE.H_GPIO.GPIO_S38_S45;//
//    FEE.H_USB.USB_Data_OUT[9]  = 	FEE.H_ADC.adc_value_Raw[0] / 256;//
//    FEE.H_USB.USB_Data_OUT[10] =	FEE.H_ADC.adc_value_Raw[0] % 256;//
//    FEE.H_USB.USB_Data_OUT[11] =	FEE.H_ADC.adc_value_Raw[1] / 256;//
//    FEE.H_USB.USB_Data_OUT[12] =	FEE.H_ADC.adc_value_Raw[1] % 256;//
//    FEE.H_USB.USB_Data_OUT[13] =  FEE.H_ADC.adc_value_Raw[2] / 256;
//    FEE.H_USB.USB_Data_OUT[14] =	FEE.H_ADC.adc_value_Raw[2] % 256;//
//    FEE.H_USB.USB_Data_OUT[15] =  FEE.H_ADC.adc_value_Raw[3] / 256;
//    FEE.H_USB.USB_Data_OUT[16] =	FEE.H_ADC.adc_value_Raw[3] % 256;//
//    FEE.H_USB.USB_Data_OUT[17] =  FEE.H_ADC.adc_value_Raw[4] / 256;
//    FEE.H_USB.USB_Data_OUT[18] =	FEE.H_ADC.adc_value_Raw[4] % 256;//
//    FEE.H_USB.USB_Data_OUT[19] =  FEE.H_ADC.adc_value_Raw[5] / 256;
//    FEE.H_USB.USB_Data_OUT[20] =	FEE.H_ADC.adc_value_Raw[5] % 256;//
//    FEE.H_USB.USB_Data_OUT[21] =  FEE.H_ADC.adc_value_Raw[6] / 256;
//    FEE.H_USB.USB_Data_OUT[22] =	FEE.H_ADC.adc_value_Raw[6] % 256;//
//    FEE.H_USB.USB_Data_OUT[23] =  FEE.H_ADC.adc_value_Raw[7] / 256;
//    FEE.H_USB.USB_Data_OUT[24] =  FEE.H_ADC.adc_value_Raw[7] % 256;//
        FEE.H_USB.USB_Data_OUT[25] =  FEE.H_GPIO.EXTI_Counter1 / 256;
        FEE.H_USB.USB_Data_OUT[26] =  FEE.H_GPIO.EXTI_Counter1 % 256;
        FEE.H_USB.USB_Data_OUT[27] =  FEE.H_GPIO.EXTI_Counter2 / 256;
        FEE.H_USB.USB_Data_OUT[28] =  FEE.H_GPIO.EXTI_Counter2 % 256;
        FEE.H_USB.USB_Data_OUT[29] =  FEE.H_GPIO.EXTI_Counter3 / 256;
        FEE.H_USB.USB_Data_OUT[30] =  FEE.H_GPIO.EXTI_Counter3 % 256;
        FEE.H_USB.USB_Data_OUT[31] =  FEE.H_GPIO.EXTI_Counter4 / 256;
        FEE.H_USB.USB_Data_OUT[32] =  FEE.H_GPIO.EXTI_Counter4 % 256;
        FEE.H_USB.USB_Data_OUT[33] =  FEE.H_GPIO.EXTI_Counter5 / 256;
        FEE.H_USB.USB_Data_OUT[34] =  FEE.H_GPIO.EXTI_Counter5 % 256;
    }
    else if(FEE.H_EEprom.Read_Start == 1)
    {
        if(FEE.H_EEprom.Read_Point == 0)
        {
            FEE.H_USB.USB_Data_OUT[25] =  FEE.H_EEprom.Eeprom_Data[0] / 256;
            FEE.H_USB.USB_Data_OUT[26] =  FEE.H_EEprom.Eeprom_Data[0] % 256;
            FEE.H_USB.USB_Data_OUT[27] =  FEE.H_EEprom.Eeprom_Data[1] / 256;
            FEE.H_USB.USB_Data_OUT[28] =  FEE.H_EEprom.Eeprom_Data[1] % 256;
            FEE.H_USB.USB_Data_OUT[29] =  FEE.H_EEprom.Eeprom_Data[2] / 256;
            FEE.H_USB.USB_Data_OUT[30] =  FEE.H_EEprom.Eeprom_Data[2] % 256;
            FEE.H_USB.USB_Data_OUT[31] =  FEE.H_EEprom.Eeprom_Data[3] / 256;
            FEE.H_USB.USB_Data_OUT[32] =  FEE.H_EEprom.Eeprom_Data[3] % 256;
            FEE.H_USB.USB_Data_OUT[33] =  FEE.H_EEprom.Eeprom_Data[4] / 256;
            FEE.H_USB.USB_Data_OUT[34] =  FEE.H_EEprom.Eeprom_Data[4] % 256;
            FEE.H_USB.USB_Data_OUT[63] =  FEE.H_EEprom.Read_Point;
            FEE.H_EEprom.Read_Point = 1;
        }
        else if(FEE.H_EEprom.Read_Point == 1)
        {
            FEE.H_USB.USB_Data_OUT[25] =  FEE.H_EEprom.Eeprom_Data[5] / 256;
            FEE.H_USB.USB_Data_OUT[26] =  FEE.H_EEprom.Eeprom_Data[5] % 256;
            FEE.H_USB.USB_Data_OUT[27] =  FEE.H_EEprom.Eeprom_Data[6] / 256;
            FEE.H_USB.USB_Data_OUT[28] =  FEE.H_EEprom.Eeprom_Data[6] % 256;
            FEE.H_USB.USB_Data_OUT[29] =  FEE.H_EEprom.Eeprom_Data[7] / 256;
            FEE.H_USB.USB_Data_OUT[30] =  FEE.H_EEprom.Eeprom_Data[7] % 256;
            FEE.H_USB.USB_Data_OUT[31] =  FEE.H_EEprom.Eeprom_Data[8] / 256;
            FEE.H_USB.USB_Data_OUT[32] =  FEE.H_EEprom.Eeprom_Data[8] % 256;
            FEE.H_USB.USB_Data_OUT[33] =  FEE.H_EEprom.Eeprom_Data[9] / 256;
            FEE.H_USB.USB_Data_OUT[34] =  FEE.H_EEprom.Eeprom_Data[9] % 256;
            FEE.H_USB.USB_Data_OUT[63] =  FEE.H_EEprom.Read_Point;
            FEE.H_EEprom.Read_Point = 2;
        }
        else if(FEE.H_EEprom.Read_Point == 2)
        {
            FEE.H_USB.USB_Data_OUT[25] =  FEE.H_EEprom.Eeprom_Data[10] / 256;
            FEE.H_USB.USB_Data_OUT[26] =  FEE.H_EEprom.Eeprom_Data[10] % 256;
            FEE.H_USB.USB_Data_OUT[27] =  FEE.H_EEprom.Eeprom_Data[11] / 256;
            FEE.H_USB.USB_Data_OUT[28] =  FEE.H_EEprom.Eeprom_Data[11] % 256;
            FEE.H_USB.USB_Data_OUT[29] =  FEE.H_EEprom.Eeprom_Data[12] / 256;
            FEE.H_USB.USB_Data_OUT[30] =  FEE.H_EEprom.Eeprom_Data[12] % 256;
            FEE.H_USB.USB_Data_OUT[31] =  FEE.H_EEprom.Eeprom_Data[13] / 256;
            FEE.H_USB.USB_Data_OUT[32] =  FEE.H_EEprom.Eeprom_Data[13] % 256;
            FEE.H_USB.USB_Data_OUT[33] =  FEE.H_EEprom.Eeprom_Data[14] / 256;
            FEE.H_USB.USB_Data_OUT[34] =  FEE.H_EEprom.Eeprom_Data[14] % 256;
            FEE.H_USB.USB_Data_OUT[63] =  FEE.H_EEprom.Read_Point;
            FEE.H_EEprom.Read_Point = 3;
        }
        else if(FEE.H_EEprom.Read_Point == 3)
        {
            FEE.H_USB.USB_Data_OUT[25] =  FEE.H_EEprom.Eeprom_Data[15] / 256;
            FEE.H_USB.USB_Data_OUT[26] =  FEE.H_EEprom.Eeprom_Data[15] % 256;
            FEE.H_USB.USB_Data_OUT[27] =  FEE.H_EEprom.Eeprom_Data[16] / 256;
            FEE.H_USB.USB_Data_OUT[28] =  FEE.H_EEprom.Eeprom_Data[16] % 256;
            FEE.H_USB.USB_Data_OUT[29] =  FEE.H_EEprom.Eeprom_Data[17] / 256;
            FEE.H_USB.USB_Data_OUT[30] =  FEE.H_EEprom.Eeprom_Data[17] % 256;
            FEE.H_USB.USB_Data_OUT[31] =  FEE.H_EEprom.Eeprom_Data[18] / 256;
            FEE.H_USB.USB_Data_OUT[32] =  FEE.H_EEprom.Eeprom_Data[18] % 256;
            FEE.H_USB.USB_Data_OUT[33] =  FEE.H_EEprom.Eeprom_Data[19] / 256;
            FEE.H_USB.USB_Data_OUT[34] =  FEE.H_EEprom.Eeprom_Data[19] % 256;
            FEE.H_USB.USB_Data_OUT[63] =  FEE.H_EEprom.Read_Point;
            FEE.H_EEprom.Read_Point = 0;
        }
    }


    FEE.H_USB.USB_Data_OUT[35] =  FEE.H_Compass.xH;//FEE.H_GPIO.EXTI_Counter6 / 256;
    FEE.H_USB.USB_Data_OUT[36] =  FEE.H_Compass.xL;//FEE.H_GPIO.EXTI_Counter6 / 256;
    FEE.H_USB.USB_Data_OUT[37] =  FEE.H_Compass.yH;//FEE.H_GPIO.EXTI_Counter7 / 256;
    FEE.H_USB.USB_Data_OUT[38] =  FEE.H_Compass.yL;//FEE.H_GPIO.EXTI_Counter7 / 256;
    FEE.H_USB.USB_Data_OUT[39] =  FEE.H_Compass.zH;//FEE.H_GPIO.EXTI_Counter8 / 256;
    FEE.H_USB.USB_Data_OUT[40] =  FEE.H_Compass.zL;//FEE.H_GPIO.EXTI_Counter8 / 256;
    FEE.H_USB.USB_Data_OUT[41] = (FEE.H_Compass.fAngle + 32768) / 256;
    FEE.H_USB.USB_Data_OUT[42] = (FEE.H_Compass.fAngle + 32768) % 256;
    FEE.H_USB.USB_Data_OUT[43] =  FEE.H_Remote.rxBuffer[0];//
    FEE.H_USB.USB_Data_OUT[44] =  FEE.H_Remote.rxBuffer[1];
    FEE.H_USB.USB_Data_OUT[45] =  FEE.H_Remote.rxBuffer[2];
    FEE.H_USB.USB_Data_OUT[46] =  FEE.H_Remote.rxBuffer[3];//
    FEE.H_USB.USB_Data_OUT[47] =  FEE.H_Remote.rxBuffer[4];
    FEE.H_USB.USB_Data_OUT[48] =  FEE.H_Remote.rxBuffer[5];//
    FEE.H_USB.USB_Data_OUT[49] =  FEE.H_Remote.rxBuffer[6];
    FEE.H_USB.USB_Data_OUT[50] =  FEE.H_Remote.rxBuffer[7];
    FEE.H_USB.USB_Data_OUT[51] =  (FEE.H_Compass.x_offset + 32768) / 256;
    FEE.H_USB.USB_Data_OUT[52] =  (FEE.H_Compass.x_offset + 32768) % 256;
    FEE.H_USB.USB_Data_OUT[53] =  (FEE.H_Compass.y_offset + 32768) / 256;
    FEE.H_USB.USB_Data_OUT[54] =  (FEE.H_Compass.y_offset + 32768) % 256;
    FEE.H_USB.USB_Data_OUT[55] =  (FEE.H_Compass.z_offset + 32768) / 256;
    FEE.H_USB.USB_Data_OUT[56] =  (FEE.H_Compass.z_offset + 32768) % 256;
    FEE.H_USB.USB_Data_OUT[57] =  (FEE.H_Compass.x_Axis + 32768) / 256;
    FEE.H_USB.USB_Data_OUT[58] =  (FEE.H_Compass.x_Axis + 32768) % 256;
    FEE.H_USB.USB_Data_OUT[59] =  (FEE.H_Compass.y_Axis + 32768) / 256;
    FEE.H_USB.USB_Data_OUT[60] =  (FEE.H_Compass.y_Axis + 32768) % 256;
    FEE.H_USB.USB_Data_OUT[61] =  (FEE.H_Compass.z_Axis + 32768) / 256;
    FEE.H_USB.USB_Data_OUT[62] =  (FEE.H_Compass.z_Axis + 32768) % 256;

    //FEE.H_USB.USB_Data_OUT[63] =  FEE.H_EEprom.Read_Point;

    USBD_CUSTOM_HID_SendReport(pdev1, FEE.H_USB.USB_Data_OUT, 64);

    //		if(Process_done==1) Process_done=0;
    //if(PID_struct._PID_Uart_OK == 1) PID_struct._PID_Uart_OK = 0;

}

/********************* HID_Read_Packet : nhan 64 byte data USB_Custom_HID **********************************/

void HID_Read_Packet(void)
{
    // luu tru 63 byte du lieu
    for(pj = 0; pj < 63; pj++)
    {
        FEE.H_USB.USB_Data_IN[pj] = hhid1->Report_buf[pj + 1];
    }

    FEE.H_EEprom.Read_Start = hhid1->Report_buf[3];
    FEE.H_EEprom.PageNum = hhid1->Report_buf[4];

    for(pj = 0; pj < 20; pj++)
    {
        FEE.H_EEprom.USB_Data[pj] = hhid1->Report_buf[pj * 2 + 5] * 256 + hhid1->Report_buf[pj * 2 + 6];
    }

    if(FEE.H_EEprom.Read_Start == 2)
    {
        FEE.H_EEprom.Counter++;
        uint8_t *data;

        data = (uint8_t*)&FEE.H_EEprom.USB_Data[0];
        EEPROM_Write(FEE.H_EEprom.PageNum,0,data,40);
        FEE.H_EEprom.Write_Done = 1;
        FEE.H_EEprom.Read_Done = 0;

        HAL_Delay(10);

        data = (uint8_t*)&FEE.H_EEprom.Eeprom_Data[0];
        EEPROM_Read(FEE.H_EEprom.PageNum,0,data,40);
        FEE.H_EEprom.Read_Done = 1;
        FEE.H_EEprom.Write_Done = 0;
    }
}


